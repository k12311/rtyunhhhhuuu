<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ç¬¬1ï½3èª² è‡ªé¸å–®å­—ç·´ç¿’</title>
  <style>
    body {
      font-family: "Helvetica Neue", sans-serif;
      background-color: #ffe4f0;
      color: #333;
      padding: 20px;
      text-align: center;
    }
    .lesson {
      background: #fff0f5;
      padding: 10px;
      margin: 20px auto;
      width: fit-content;
      border-radius: 12px;
      text-align: left;
    }
    .lesson h3 {
      margin-top: 0;
    }
    .option-button {
      background-color: #fff;
      margin: 5px;
      padding: 10px 20px;
      border: 2px solid #ff99cc;
      border-radius: 12px;
      font-size: 16px;
      cursor: pointer;
    }
    button {
      padding: 10px 16px;
      margin: 10px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      background-color: #ffccdd;
      cursor: pointer;
    }
    #result {
      margin-top: 10px;
      font-size: 18px;
      font-weight: bold;
    }
    #question {
      font-size: 22px;
      margin: 20px 0;
    }
    #quizArea {
      margin-top: 30px;
      padding: 20px;
      background: #fffafc;
      border-radius: 12px;
    }
  </style>
</head>
<body>
  <h1>ç¬¬7ï½9èª² è‡ªé¸å–®å­—ç·´ç¿’</h1>

  <div>
    é¡Œç›®æ–¹å‘ï¼š
    <select id="modeSelect">
      <option value="jpToZh">æ—¥æ–‡ â¡ ä¸­æ–‡ï¼ˆé è¨­ï¼‰</option>
      <option value="zhToJp">ä¸­æ–‡ â¡ æ—¥æ–‡</option>
    </select>
  </div>

  <div>
    é¡Œå‹é¸æ“‡ï¼š
    <select id="typeSelect">
      <option value="choice">é¸æ“‡é¡Œï¼ˆé è¨­ï¼‰</option>
      <option value="input">æ‰“å­—é¡Œ</option>
    </select>
  </div>

  <div>
    é¸æ“‡èª²æ¬¡ï¼š
    <select id="lessonSelect">
      <option value="">-- è«‹é¸æ“‡èª²æ¬¡ --</option>
      <option value="ç¬¬1èª²">ç¬¬1èª²</option>
      <option value="ç¬¬2èª²">ç¬¬2èª²</option>
      <option value="ç¬¬3èª²">ç¬¬3èª²</option>
    </select>
  </div>

  <div id="wordSelection"></div>
  <button onclick="startQuiz()">â–¶ï¸ é–‹å§‹æ¸¬é©—</button>
  <button onclick="unlockSelection()">ğŸ” é‡æ–°é¸å–®å­—</button>

  <div id="quizArea">
    <div id="question">â† é»ä¸Šæ–¹æŒ‰éˆ•é–‹å§‹ç·´ç¿’</div>
    <div id="options"></div>
    <div id="result"></div>
    <div>
      åˆ†æ•¸ï¼š<span id="score">0</span><br>
      æœ€é«˜åˆ†ï¼š<span id="highscore">0</span><br>
      ç­”å°ç‡ï¼š<span id="accuracy">0%</span>ï¼ˆ<span id="correct">0</span> / <span id="total">0</span> é¡Œï¼‰
    </div>
    <button onclick="speakWord()">ğŸ”Š æœ—è®€æ—¥æ–‡</button>
    <button onclick="resetScore()">ğŸ” é‡ç½®åˆ†æ•¸</button>
  </div>

  <div id="endScreen" style="display: none; margin-top: 20px; text-align: center;">
    <h3>ğŸ‰ æ¸¬é©—å®Œæˆï¼</h3>
    <p>ä½ çš„ç¸½å¾—åˆ†æ˜¯ï¼š<span id="finalScore">0</span> åˆ†</p>
    <button onclick="goHome()">ğŸ”™ å›é¦–é </button>
  </div>

  <div style="margin-top: 20px;">
    <button onclick="showHistory()">ğŸ“œ çœ‹æ­·å²ç´€éŒ„</button>
  </div>

  <div id="historyArea" style="display:none; margin-top: 20px; padding: 10px; background: #fff; border: 2px dashed #ff99cc; border-radius: 12px;">
    <h3>ğŸ“š æ­·å²ç´€éŒ„</h3>
    <div id="historyList"></div>
    <button onclick="clearHistory()">ğŸ—‘ æ¸…é™¤ç´€éŒ„</button>
    <button onclick="hideHistory()">âŒ é—œé–‰</button>
  </div>

  <script>
    const allLessons = {
  "ç¬¬1èª²": [
    { jp: "ã‚ãŸã—", zh: "æˆ‘" }, { jp: "ã‚ãªãŸ", zh: "ä½ " }, { jp: "ã‚ã®ã²ã¨ï¼ˆã‚ã®äººï¼‰", zh: "é‚£å€‹äººã€ä»–ã€å¥¹" },
    { jp: "ã¿ãªã•ã‚“", zh: "å„ä½ã€å¤§å®¶" }, { jp: "ï½ã•ã‚“", zh: "ï½å…ˆç”Ÿã€ï½å°å§" }, { jp: "ï½ã¡ã‚ƒã‚“", zh: "ï½ï¼ˆç”¨æ–¼å°å­©åå­—å¾Œï¼‰" },
    { jp: "ï½ãã‚“", zh: "ï½å›ï¼ˆç”¨æ–¼ç”·å­©åå­—å¾Œï¼‰" }, { jp: "ï½ã˜ã‚“ï¼ˆï½äººï¼‰", zh: "ï½äººï¼ˆè¡¨åœ‹ç±ï¼‰" }, { jp: "ã›ã‚“ã›ã„ï¼ˆå…ˆç”Ÿï¼‰", zh: "è€å¸«ï¼ˆä¸æŒ‡è‡ªå·±çš„è·æ¥­ï¼‰" },
    { jp: "ãã‚‡ã†ã—ï¼ˆæ•™å¸«ï¼‰", zh: "æ•™å¸«ï¼ˆæŒ‡è‡ªå·±çš„è·æ¥­ï¼‰" }, { jp: "ãŒãã›ã„ï¼ˆå­¦ç”Ÿï¼‰", zh: "å­¸ç”Ÿ" }, { jp: "ã‹ã„ã—ã‚ƒã„ã‚“ï¼ˆä¼šç¤¾å“¡ï¼‰", zh: "å…¬å¸è·å“¡" },
    { jp: "ã—ã‚ƒã„ã‚“ï¼ˆç¤¾å“¡ï¼‰", zh: "ï½å…¬å¸çš„è·å“¡" }, { jp: "ãã‚“ã“ã†ã„ã‚“ï¼ˆéŠ€è¡Œå“¡ï¼‰", zh: "éŠ€è¡Œè·å“¡" }, { jp: "ã„ã—ã‚ƒï¼ˆåŒ»è€…ï¼‰", zh: "é†«ç”Ÿ" },
    { jp: "ã‘ã‚“ãã‚…ã†ã—ã‚ƒï¼ˆç ”ç©¶è€…ï¼‰", zh: "ç ”ç©¶äººå“¡" }, { jp: "ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢", zh: "å·¥ç¨‹å¸«" }, { jp: "ã ã„ãŒãï¼ˆå¤§å­¦ï¼‰", zh: "å¤§å­¸" },
    { jp: "ã³ã‚‡ã†ã„ã‚“ï¼ˆç—…é™¢ï¼‰", zh: "é†«é™¢" }, { jp: "ã ã‚Œï¼ˆã©ãªãŸï¼‰", zh: "èª°ï¼ˆå“ªä½ï¼‰" }, { jp: "ï½ã•ã„ï¼ˆï½æ­³ï¼‰", zh: "ï½æ­²" },
    { jp: "ãªã‚“ã•ã„ï¼ˆãŠã„ãã¤ï¼‰", zh: "å¹¾æ­²" }, { jp: "ã¯ã„", zh: "æ˜¯" }, { jp: "ã„ã„ãˆ", zh: "ä¸æ˜¯" },
    { jp: "ã—ã¤ã‚Œã„ã§ã™ãŒ", zh: "å°ä¸èµ·ï¼Œè«‹å•â€¦" }, { jp: "ãŠãªã¾ãˆã¯ï¼Ÿ", zh: "æ‚¨è²´å§“ï¼Ÿ" }, { jp: "ã¯ã˜ã‚ã¾ã—ã¦ã€‚", zh: "åˆæ¬¡è¦‹é¢ã€‚" },
    { jp: "ã©ã†ã ã‚ˆã‚ã—ã ãŠã­ãŒã„ã—ã¾ã™ã€‚", zh: "è«‹å¤šé—œç…§ã€‚" }, { jp: "ã“ã¡ã‚‰ã¯ï½ã•ã‚“ã§ã™ã€‚", zh: "é€™ä½æ˜¯ï½å…ˆç”Ÿï¼å°å§ã€‚" }, { jp: "ï½ã‹ã‚‰ ãã¾ã—ãŸã€‚", zh: "æˆ‘å¾ï½ä¾†ã€‚" }
  ],
  "ç¬¬2èª²": [
    { jp: "ã“ã‚Œ", zh: "é€™å€‹" }, { jp: "ãã‚Œ", zh: "é‚£å€‹" }, { jp: "ã‚ã‚Œ", zh: "é‚£å€‹ï¼ˆé æ–¹ï¼‰" },
    { jp: "ã“ã®ï½", zh: "é€™ï½" }, { jp: "ãã®ï½", zh: "é‚£ï½" }, { jp: "ã‚ã®ï½", zh: "é‚£ï½ï¼ˆé æ–¹ï¼‰" },
    { jp: "ã»ã‚“ï¼ˆæœ¬ï¼‰", zh: "æ›¸" }, { jp: "ã˜ã—ã‚‡ï¼ˆè¾æ›¸ï¼‰", zh: "å­—å…¸" }, { jp: "ã–ã£ã—ï¼ˆé›‘èªŒï¼‰", zh: "é›œèªŒ" },
    { jp: "ã—ã‚“ã¶ã‚“ï¼ˆæ–°èï¼‰", zh: "å ±ç´™" }, { jp: "ãƒãƒ¼ãƒˆ", zh: "ç­†è¨˜æœ¬" }, { jp: "ã¦ã¡ã‚‡ã†ï¼ˆæ‰‹å¸³ï¼‰", zh: "è¨˜äº‹æœ¬" },
    { jp: "ã‚ã„ã—ï¼ˆååˆºï¼‰", zh: "åç‰‡" }, { jp: "ã‚«ãƒ¼ãƒ‰", zh: "å¡ç‰‡" }, { jp: "ãˆã‚“ã´ã¤ï¼ˆé‰›ç­†ï¼‰", zh: "é‰›ç­†" },
    { jp: "ãƒœãƒ¼ãƒ«ãƒšãƒ³", zh: "åŸå­ç­†" }, { jp: "ã‚·ãƒ£ãƒ¼ãƒ—ãƒšãƒ³ã‚·ãƒ«", zh: "è‡ªå‹•é‰›ç­†" }, { jp: "ã‹ãï¼ˆéµï¼‰", zh: "é‘°åŒ™" },
    { jp: "ã‹ã•ï¼ˆå‚˜ï¼‰", zh: "å‚˜" }, { jp: "ã‹ã°ã‚“", zh: "åŒ…åŒ…ã€æ›¸åŒ…" }, { jp: "ï¼»ã‚«ã‚»ãƒƒãƒˆï¼½ãƒ†ãƒ¼ãƒ—", zh: "éŒ„éŸ³å¸¶" },
    { jp: "ãƒ†ãƒ¼ãƒ—ãƒ¬ã‚³ãƒ¼ãƒ€ãƒ¼", zh: "éŒ„éŸ³æ©Ÿ" }, { jp: "ãƒ†ãƒ¬ãƒ“", zh: "é›»è¦–" }, { jp: "ãƒ©ã‚¸ã‚ª", zh: "æ”¶éŸ³æ©Ÿ" },
    { jp: "ã‚«ãƒ¡ãƒ©", zh: "ç›¸æ©Ÿ" }, { jp: "ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼", zh: "é›»è…¦" }, { jp: "ã˜ã©ã†ã—ã‚ƒï¼ˆè‡ªå‹•è»Šï¼‰", zh: "æ±½è»Š" },
    { jp: "ã¤ããˆï¼ˆæœºï¼‰", zh: "æ¡Œå­" }, { jp: "ã„ã™", zh: "æ¤…å­" }, { jp: "ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆ", zh: "å·§å…‹åŠ›" },
    { jp: "ã‚³ãƒ¼ãƒ’ãƒ¼", zh: "å’–å•¡" }, { jp: "ãˆã„ã”ï¼ˆè‹±èªï¼‰", zh: "è‹±èª" }, { jp: "ã«ã»ã‚“ã”ï¼ˆæ—¥æœ¬èªï¼‰", zh: "æ—¥èª" },
    { jp: "ï½ã”ï¼ˆï½èªï¼‰", zh: "ï½èªè¨€" }, { jp: "ãªã‚“ï¼ˆä½•ï¼‰", zh: "ä»€éº¼" }, { jp: "ãã†", zh: "æ˜¯" },
    { jp: "ã¡ãŒã„ã¾ã™", zh: "ä¸æ˜¯" }, { jp: "ã‚ã®ã†", zh: "å—¯â€¦" }, { jp: "ãã†ã§ã™ã‹", zh: "æ˜¯é€™æ¨£å•Š" },
    { jp: "ã‚ã®ã†ã€ã»ã‚“ã®ãã‚‚ã¡ã§ã™ã€‚", zh: "é‚£å€‹ï¼Œåªæ˜¯å°æ„æ€ã€‚" }, { jp: "ã©ã†ã", zh: "è«‹â€¦" }, { jp: "ã©ã†ã‚‚", zh: "è¬äº†" },
    { jp: "ï¼»ã©ã†ã‚‚ï¼½ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚", zh: "éå¸¸è¬è¬æ‚¨ã€‚" }, { jp: "ã“ã‚Œã‹ã‚‰ ãŠã›ã‚ã« ãªã‚Šã¾ã™ã€‚", zh: "ä»Šå¾Œæœƒæ‰¿è’™æ‚¨çš„ç…§é¡§ã€‚" },
    { jp: "ã“ã¡ã‚‰ã“ã ã‚ˆã‚ã—ãã€‚", zh: "æˆ‘æ‰è¦è«‹æ‚¨å¤šå¤šé—œç…§ã€‚" }
  ],
  "ç¬¬3èª²": [
    { jp: "ã“ã“", zh: "é€™è£¡" }, { jp: "ãã“", zh: "é‚£è£¡" }, { jp: "ã‚ãã“", zh: "é‚£è£¡ï¼ˆé æ–¹ï¼‰" },
    { jp: "ã©ã“", zh: "å“ªè£¡" }, { jp: "ã“ã¡ã‚‰", zh: "é€™é‚Šï¼ˆç¦®è²Œèªªæ³•ï¼‰" }, { jp: "ãã¡ã‚‰", zh: "é‚£é‚Šï¼ˆç¦®è²Œèªªæ³•ï¼‰" },
    { jp: "ã‚ã¡ã‚‰", zh: "é‚£é‚Šï¼ˆé æ–¹ã€ç¦®è²Œèªªæ³•ï¼‰" }, { jp: "ã©ã¡ã‚‰", zh: "å“ªé‚Šï¼ˆç¦®è²Œèªªæ³•ï¼‰" },
    { jp: "ãã‚‡ã†ã—ã¤ï¼ˆæ•™å®¤ï¼‰", zh: "æ•™å®¤" }, { jp: "ã—ã‚‡ãã©ã†ï¼ˆé£Ÿå ‚ï¼‰", zh: "é¤å»³" }, { jp: "ã˜ã‚€ã—ã‚‡ï¼ˆäº‹å‹™æ‰€ï¼‰", zh: "è¾¦å…¬å®¤" },
    { jp: "ã‹ã„ãã—ã¤ï¼ˆä¼šè­°å®¤ï¼‰", zh: "æœƒè­°å®¤" }, { jp: "ã†ã‘ã¤ã‘ï¼ˆå—ä»˜ï¼‰", zh: "æ¥å¾…è™•" }, { jp: "ãƒ­ãƒ“ãƒ¼", zh: "å¤§å»³" },
    { jp: "ã¸ã‚„ï¼ˆéƒ¨å±‹ï¼‰", zh: "æˆ¿é–“" }, { jp: "ãƒˆã‚¤ãƒ¬ï¼ˆãŠã¦ã‚ã‚‰ã„ï¼‰", zh: "æ´—æ‰‹é–“" }, { jp: "ã‹ã„ã ã‚“ï¼ˆéšæ®µï¼‰", zh: "æ¨“æ¢¯" },
    { jp: "ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼", zh: "é›»æ¢¯" }, { jp: "ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚¿ãƒ¼", zh: "æ‰‹æ‰¶æ¢¯" }, { jp: "ï¼»ãŠï¼½ãã«ï¼ˆå›½ï¼‰", zh: "åœ‹å®¶" },
    { jp: "ã‹ã„ã—ã‚ƒï¼ˆä¼šç¤¾ï¼‰", zh: "å…¬å¸" }, { jp: "ã†ã¡", zh: "å®¶" }, { jp: "ã§ã‚“ã‚ï¼ˆé›»è©±ï¼‰", zh: "é›»è©±" },
    { jp: "ãã¤ï¼ˆé´ï¼‰", zh: "é‹å­" }, { jp: "ãƒã‚¯ã‚¿ã‚¤", zh: "é ˜å¸¶" }, { jp: "ãƒ¯ã‚¤ãƒ³", zh: "è‘¡è„é…’" },
    { jp: "ãŸã°ã“", zh: "é¦™è¸" }, { jp: "ã†ã‚Šã°ï¼ˆå£²ã‚Šå ´ï¼‰", zh: "è³£å ´ã€æ«ƒæª¯" }, { jp: "ã¡ã‹", zh: "åœ°ä¸‹" },
    { jp: "ï½ã‹ã„ï¼ˆï½éšï¼‰", zh: "ï½æ¨“" }, { jp: "ãªã‚“ãŒã„ï¼ˆä½•éšï¼‰", zh: "å¹¾æ¨“" },
    { jp: "ï½ãˆã‚“ï¼ˆï½å††ï¼‰", zh: "ï½æ—¥åœ“" }, { jp: "ã„ãã‚‰", zh: "å¤šå°‘éŒ¢" }, { jp: "ã²ã‚ƒãï¼ˆç™¾ï¼‰", zh: "ä¸€ç™¾" },
    { jp: "ã›ã‚“ï¼ˆåƒï¼‰", zh: "ä¸€åƒ" }, { jp: "ã¾ã‚“ï¼ˆä¸‡ï¼‰", zh: "ä¸€è¬" }, { jp: "ã™ã¿ã¾ã›ã‚“", zh: "å°ä¸èµ·ï¼Œè«‹å•â€¦" },
    { jp: "ï½ã§ã”ã–ã„ã¾ã™", zh: "ï½æ˜¯ï¼ˆã§ã™çš„ç¦®è²Œèªªæ³•ï¼‰" }, { jp: "ï½ã‚’ ã¿ã›ã¦ ãã ã•ã„", zh: "è«‹è®“æˆ‘çœ‹ï½" },
    { jp: "ã˜ã‚ƒ", zh: "é‚£éº¼" }, { jp: "ï¼»ï½ã‚’ï¼½ ãã ã•ã„", zh: "è«‹çµ¦æˆ‘ï¼»ï½ï¼½" }
  ]
};

     let lockedWords = [], currentWord = {}, score = 0, correctCount = 0, totalCount = 0;
    let highscore = localStorage.getItem("highscore") || 0;
    let mode = "jpToZh";
    let quizType = "choice";
    let wrongAnswers = [];

    document.getElementById("highscore").textContent = highscore;

    document.getElementById("modeSelect").onchange = () => mode = modeSelect.value;
    document.getElementById("typeSelect").onchange = () => quizType = typeSelect.value;
    document.getElementById("lessonSelect").onchange = updateWordList;

    function updateWordList() {
      const lesson = lessonSelect.value;
      const container = document.getElementById("wordSelection");
      container.innerHTML = "";
      if (!lesson || !allLessons[lesson]) return;
      const list = allLessons[lesson];
      const div = document.createElement("div");
      div.className = "lesson";
      const idPrefix = lesson.replace("ç¬¬", "lesson").replace("èª²", "");
      div.innerHTML = `<h3>${lesson} <button onclick="uncheckAll('${idPrefix}')">å…¨éƒ¨å–æ¶ˆ</button></h3>`;
      list.forEach((word, i) => {
        const id = `${idPrefix}_word${i}`;
        div.innerHTML += `<label><input type="checkbox" id="${id}" value="${word.jp}" checked> ${word.jp}ï¼ˆ${word.zh}ï¼‰</label><br>`;
      });
      container.appendChild(div);
    }

    function uncheckAll(prefix) {
      document.querySelectorAll(`input[id^='${prefix}_']`).forEach(cb => cb.checked = false);
    }

    function getSelectedWords() {
      const lesson = lessonSelect.value;
      const prefix = lesson.replace("ç¬¬", "lesson").replace("èª²", "");
      return allLessons[lesson].filter((_, i) => document.getElementById(`${prefix}_word${i}`).checked);
    }

    function startQuiz() {
      const selected = getSelectedWords();
      if (selected.length === 0) return alert("è«‹è‡³å°‘é¸ä¸€å€‹å–®å­—ï¼");
      lockedWords = [...selected];
      wrongAnswers = [];
      document.getElementById("wordSelection").style.display = "none";
      showNewQuestion();
    }

    function unlockSelection() {
      document.getElementById("wordSelection").style.display = "block";
      lockedWords = [];
      document.getElementById("question").textContent = "â† é»ä¸Šæ–¹æŒ‰éˆ•é–‹å§‹ç·´ç¿’";
      document.getElementById("options").innerHTML = "";
      document.getElementById("result").textContent = "";
    }

    function shuffle(array) {
      return array.sort(() => Math.random() - 0.5);
    }

    function showNewQuestion() {
      currentWord = lockedWords[Math.floor(Math.random() * lockedWords.length)];
      const lesson = lessonSelect.value;
      const fullWords = allLessons[lesson];
      const correct = mode === "jpToZh" ? currentWord.zh : currentWord.jp;
      const qText = mode === "jpToZh" ? `ã€Œ${currentWord.jp}ã€æ˜¯ä»€éº¼æ„æ€ï¼Ÿ` : `ã€Œ${currentWord.zh}ã€çš„æ—¥æ–‡æ˜¯ä»€éº¼ï¼Ÿ`;
      document.getElementById("question").textContent = qText;
      document.getElementById("result").textContent = "";

      const pool = fullWords.map(w => mode === "jpToZh" ? w.zh : w.jp).filter(opt => opt !== correct);
      const options = shuffle([correct, ...shuffle(pool).slice(0, 3)]);
      const optionsDiv = document.getElementById("options");
      optionsDiv.innerHTML = "";

      if (quizType === "choice") {
        options.forEach(opt => {
          const btn = document.createElement("button");
          btn.className = "option-button";
          btn.textContent = opt;
          btn.onclick = () => checkAnswer(opt);
          optionsDiv.appendChild(btn);
        });
      } else {
        const input = document.createElement("input");
        input.type = "text";
        input.id = "inputAnswer";
        input.style.fontSize = "18px";
        input.style.padding = "5px";
        const submitBtn = document.createElement("button");
        submitBtn.textContent = "é€å‡º";
        submitBtn.className = "option-button";
        submitBtn.onclick = () => checkAnswer(input.value.trim());
        optionsDiv.appendChild(input);
        optionsDiv.appendChild(submitBtn);
        input.focus();
      }
    }

    function checkAnswer(answer) {
      const correct = mode === "jpToZh" ? currentWord.zh : currentWord.jp;
      totalCount++;
      const isCorrect = answer.toLowerCase() === correct.toLowerCase();
      if (isCorrect) {
        correctCount++;
        document.getElementById("result").textContent = "âœ… æ­£ç¢ºï¼";
        score += 10;
      } else {
        document.getElementById("result").textContent = `âŒ éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ã€Œ${correct}ã€`;
        wrongAnswers.push(currentWord);
      }
      updateStats();
      lockedWords = lockedWords.filter(w => w !== currentWord);
      if (lockedWords.length === 0) {
        document.getElementById("quizArea").style.display = "none";
        document.getElementById("endScreen").style.display = "block";
        document.getElementById("finalScore").textContent = score;
        saveHistoryRecord();
        if (wrongAnswers.length > 0) {
          const retryBtn = document.createElement("button");
          retryBtn.textContent = "ğŸ” å†ç·´éŒ¯çš„é¡Œç›®";
          retryBtn.onclick = () => {
            lockedWords = [...wrongAnswers];
            wrongAnswers = [];
            document.getElementById("quizArea").style.display = "block";
            document.getElementById("endScreen").style.display = "none";
            showNewQuestion();
          };
          document.getElementById("endScreen").appendChild(retryBtn);
        }
      } else {
        setTimeout(showNewQuestion, 800);
      }
    }

    function updateStats() {
      document.getElementById("score").textContent = score;
      document.getElementById("correct").textContent = correctCount;
      document.getElementById("total").textContent = totalCount;
      document.getElementById("accuracy").textContent = `${Math.round((correctCount / totalCount) * 100)}%`;
      if (score > highscore) {
        highscore = score;
        localStorage.setItem("highscore", highscore);
        document.getElementById("highscore").textContent = highscore;
      }
    }

    function resetScore() {
      score = 0; correctCount = 0; totalCount = 0;
      updateStats();
      document.getElementById("result").textContent = "";
    }

    function speakWord() {
      const speakText = currentWord.jp || "";
      if (!speakText) return;
      speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(speakText);
      utter.lang = 'ja-JP';
      const voices = speechSynthesis.getVoices();
      const jpVoice = voices.find(v => v.lang === 'ja-JP');
      if (jpVoice) utter.voice = jpVoice;
      speechSynthesis.speak(utter);
    }

    function goHome() {
      document.getElementById("endScreen").style.display = "none";
      document.getElementById("quizArea").style.display = "block";
      document.getElementById("wordSelection").style.display = "block";
      document.getElementById("question").textContent = "â† é»ä¸Šæ–¹æŒ‰éˆ•é–‹å§‹ç·´ç¿’";
      document.getElementById("options").innerHTML = "";
      document.getElementById("result").textContent = "";
      score = 0;
      document.getElementById("score").textContent = score;
    }

    function saveHistoryRecord() {
      const now = new Date();
      const record = {
        time: now.toLocaleString(),
        total: totalCount,
        correct: correctCount,
        accuracy: Math.round((correctCount / totalCount) * 100)
      };
      const history = JSON.parse(localStorage.getItem("quizHistory") || "[]");
      history.unshift(record);
      localStorage.setItem("quizHistory", JSON.stringify(history));
    }

    function showHistory() {
      const history = JSON.parse(localStorage.getItem("quizHistory") || "[]");
      const listDiv = document.getElementById("historyList");
      listDiv.innerHTML = history.length === 0 ? "ç›®å‰æ²’æœ‰ç´€éŒ„ã€‚" : "";
      history.forEach((record, i) => {
        const div = document.createElement("div");
        div.innerHTML = `${i + 1}. ğŸ•’ ${record.time}ï½œğŸ“‹ é¡Œæ•¸ï¼š${record.total}ï½œâœ… ç­”å°ï¼š${record.correct}ï½œğŸ¯ æ­£ç¢ºç‡ï¼š${record.accuracy}%`;
        div.style.marginBottom = "8px";
        listDiv.appendChild(div);
      });
      document.getElementById("historyArea").style.display = "block";
    }

    function hideHistory() {
      document.getElementById("historyArea").style.display = "none";
    }

    function clearHistory() {
      if (confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ­·å²ç´€éŒ„å—ï¼Ÿ")) {
        localStorage.removeItem("quizHistory");
        document.getElementById("historyList").innerHTML = "å·²æ¸…é™¤æ‰€æœ‰ç´€éŒ„ã€‚";
      }
    }
  </script>

  <div style="margin-top: 30px;">
    <a href="index.html">
      <button>ğŸ”™ å›é¦–é </button>
    </a>
  </div>
</body>
</html>


